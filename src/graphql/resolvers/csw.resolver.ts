import { Logger } from '@map-colonies/js-logger';
import { container } from 'tsyringe';
import { Resolver, Query, Mutation, createUnionType, Arg } from 'type-graphql';
import { Layer3DRecord, LayerRasterRecord } from '../../AUTOGENERATED/GraphQLClass';
import { CatalogManager } from '../../common/catalog-manager/catalog-manager';
import { Services } from '../../common/constants';
import { CSW } from '../../csw/csw';
import { RecordUpdatePartial, SearchOptions } from '../inputTypes';

// eslint-disable-next-line @typescript-eslint/naming-convention
const LayerMetadataMixedUnion = createUnionType({
  name: 'LayerMetadataMixed',
  types: () => [Layer3DRecord, LayerRasterRecord] as const,
  resolveType: (value) => {
    if ('accuracyLE90' in value) {
      return Layer3DRecord;
    } else {
      return LayerRasterRecord;
    }
  },
}) as LayerMetadataUnionType;

@Resolver()
export class LayerMetadataMixedResolver {
  private readonly csw: CSW;
  private readonly catalogManager: CatalogManager;
  private readonly logger: Logger;

  public constructor() {
    this.csw = container.resolve(CSW);
    this.logger = container.resolve(Services.LOGGER);
    this.catalogManager = container.resolve(CatalogManager);
  }
  // eslint-disable-next-line @typescript-eslint/no-unused-vars
  @Query((type) => [LayerMetadataMixedUnion])
  public async search(
    @Arg('start', { nullable: true })
    start?: number,
    @Arg('end', { nullable: true })
    end?: number,
    @Arg('opts', { nullable: true })
    opts?: SearchOptions
  ): Promise<LayerMetadataUnionType[]> {
    try {
      const data = await this.csw.getRecords(start, end, opts);
      return data;
    } catch (err) {
      this.logger.error(err);
      throw err;
    }
  }

  @Mutation((type) => LayerMetadataMixedUnion)
  public async updateMetadata(
    @Arg('data')
    data: RecordUpdatePartial
  ): Promise<LayerMetadataUnionType> {
    try {
      const newRecord = await this.catalogManager.updateMetadata(data as LayerMetadataUnionType);
      return newRecord;
    } catch (err) {
      this.logger.error(err);
      throw err;
    }
  }
}

export type LayerMetadataUnionType = Layer3DRecord | LayerRasterRecord;
